name: Deploy to EC2

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    name: Run bapo.sh on EC2
    runs-on: ubuntu-latest

    steps:
      - name: Connect to EC2 and run script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            # âœ… .env íŒŒì¼ ì¤„ë³„ ì‘ì„±
            touch /home/ubuntu/backend/.env

            echo "KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}" >> /home/ubuntu/backend/.env
            echo "KAKAO_REDIRECT_URI=http://localhost:5173/auth/kakao/callback" >> /home/ubuntu/backend/.env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> /home/ubuntu/backend/.env

            echo "REL_DB_HOST=mysql" >> /home/ubuntu/backend/.env
            echo "REL_DB_PORT=3306" >> /home/ubuntu/backend/.env
            echo "ENV=REL" >> /home/ubuntu/backend/.env

            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> /home/ubuntu/backend/.env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> /home/ubuntu/backend/.env
            echo "DB_USER=${{ secrets.DB_USER }}" >> /home/ubuntu/backend/.env

            # âœ… ìƒì„±ëœ .env í™•ì¸ (ì˜µì…˜)
            echo "ğŸ” ìƒì„±ëœ .env ë‚´ìš©:"
            cat /home/ubuntu/backend/.env

            # âœ… ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            /home/ubuntu/growthon/bapo.sh
