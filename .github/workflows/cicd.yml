name: Deploy to EC2

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    name: Run bapo.sh on EC2
    runs-on: ubuntu-latest

    steps:
      - name: Connect to EC2 and run script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ”§ .env íŒŒì¼ ìƒì„± ì¤‘..."
            mkdir -p /home/ubuntu/backend

            cat > /home/ubuntu/backend/.env <<EOF
MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}
KAKAO_REDIRECT_URI=http://localhost:5173/auth/kakao/callback
JWT_SECRET=${{ secrets.JWT_SECRET }}

REL_DB_HOST=mysql
REL_DB_PORT=3306
ENV=REL

DB_PASSWORD=${{ secrets.DB_PASSWORD }}
DB_NAME=${{ secrets.DB_NAME }}
DB_USER=${{ secrets.DB_USER }}
EOF

            echo "âœ… .env íŒŒì¼ ì‘ì„± ì™„ë£Œ"

            echo "ğŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
            /home/ubuntu/growthon/bapo.sh
